#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

COMPOSE_FILE="docker-compose-thislab.yml"

usage() {
  cat <<'EOF'
Usage: ./start_stack.sh <create|start|stop|delete|status|restart>

Commands:
  create   Create containers from docker-compose-thislab.yml (do not start)
  start    Start containers (creates missing containers if needed)
  stop     Stop running containers
  delete   Delete containers and networks (keeps volumes/data)
  status   Show container status
  restart  Restart running containers

Notes:
  - This script uses artifacts generated by ./build_docker.sh
  - Required files: .env and docker-compose-thislab.yml
EOF
}

require_generated_artifacts() {
  if [[ ! -f "$COMPOSE_FILE" || ! -f ".env" ]]; then
    echo "Missing generated artifacts."
    echo "Run ./build_docker.sh first to generate .env and ${COMPOSE_FILE}."
    exit 1
  fi
}

if ! command -v docker >/dev/null 2>&1; then
  echo "Docker CLI not found. Install Docker and re-run."
  exit 1
fi

ACTION="${1:-status}"
case "$ACTION" in
  create|start|stop|delete|status|restart)
    ;;
  -h|--help|help)
    usage
    exit 0
    ;;
  *)
    echo "Unknown action: $ACTION"
    usage
    exit 1
    ;;
esac

require_generated_artifacts

case "$ACTION" in
  create)
    echo "Creating containers (without starting)..."
    docker compose -f "$COMPOSE_FILE" create
    ;;
  start)
    echo "Starting containers..."
    docker compose -f "$COMPOSE_FILE" up -d
    echo "UI: http://localhost:8080"
    echo "API: http://localhost:8000"
    ;;
  stop)
    echo "Stopping containers..."
    docker compose -f "$COMPOSE_FILE" stop
    ;;
  delete)
    echo "Deleting containers and network (volumes preserved)..."
    docker compose -f "$COMPOSE_FILE" down --remove-orphans
    ;;
  status)
    docker compose -f "$COMPOSE_FILE" ps
    ;;
  restart)
    echo "Restarting containers..."
    docker compose -f "$COMPOSE_FILE" restart
    echo "UI: http://localhost:8080"
    echo "API: http://localhost:8000"
    ;;
esac

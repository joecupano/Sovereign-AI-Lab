#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

install_apt_packages() {
  sudo apt-get install -y "$@"
}

detect_cpu_info() {
  CPU_THREADS="$(nproc 2>/dev/null || echo 1)"
  CPU_MODEL="$(grep -m1 'model name' /proc/cpuinfo 2>/dev/null | cut -d: -f2- | sed 's/^ *//' || true)"
  if [[ -z "$CPU_MODEL" ]] && command -v lscpu >/dev/null 2>&1; then
    CPU_MODEL="$(lscpu | awk -F: '/Model name/ {gsub(/^ +/, "", $2); print $2; exit}')"
  fi
  CPU_MODEL="${CPU_MODEL:-unknown}"
}

detect_ram_gb() {
  local mem_kb
  mem_kb="$(awk '/MemTotal/ {print $2}' /proc/meminfo)"
  RAM_GB="$(( (mem_kb + 1048575) / 1048576 ))"
}

detect_gpu_vendor() {
  local gpu_info
  gpu_info="$(lspci 2>/dev/null | grep -Ei 'VGA|3D|Display' || true)"

  if echo "$gpu_info" | grep -qi 'NVIDIA'; then
    echo "nvidia"
  elif echo "$gpu_info" | grep -Eqi 'AMD|ATI|Advanced Micro Devices'; then
    echo "amd"
  elif echo "$gpu_info" | grep -qi 'Intel'; then
    echo "intel"
  else
    echo "none"
  fi
}

is_nvidia_driver_installed() {
  command -v nvidia-smi >/dev/null 2>&1 && nvidia-smi >/dev/null 2>&1
}

is_amd_driver_installed() {
  lsmod | grep -q '^amdgpu'
}

is_intel_driver_installed() {
  lsmod | grep -q '^i915'
}

install_gpu_drivers_if_missing() {
  case "$GPU_VENDOR" in
    nvidia)
      if is_nvidia_driver_installed; then
        echo "NVIDIA driver detected."
      else
        echo "NVIDIA GPU detected, driver appears missing. Installing..."
        if ! command -v ubuntu-drivers >/dev/null 2>&1; then
          install_apt_packages ubuntu-drivers-common
        fi
        sudo ubuntu-drivers autoinstall
      fi
      ;;
    amd)
      if is_amd_driver_installed; then
        echo "AMD driver detected."
      else
        echo "AMD GPU detected, driver appears missing. Installing support packages..."
        install_apt_packages firmware-amd-graphics mesa-vulkan-drivers mesa-opencl-icd
      fi
      ;;
    intel)
      if is_intel_driver_installed; then
        echo "Intel driver detected."
      else
        echo "Intel GPU detected, driver appears missing. Installing support packages..."
        install_apt_packages intel-media-va-driver-non-free mesa-vulkan-drivers
      fi
      ;;
    none)
      echo "No supported GPU detected. Skipping GPU driver installation."
      ;;
    *)
      echo "Unknown GPU vendor '$GPU_VENDOR'. Skipping GPU driver installation."
      ;;
  esac
}

set_profile_values() {
  if [[ "$GPU_VENDOR" == "nvidia" || "$GPU_VENDOR" == "amd" ]]; then
    PROFILE="gpu-6gb-64gb"
    OLLAMA_MODEL="mixtral:8x7b"
    TOP_K="8"
    MAX_CONTEXT_CHARS="20000"
    GEN_NUM_CTX="16384"
    GEN_NUM_PREDICT="2048"
    GEN_NUM_THREAD="4"
  elif (( RAM_GB <= 16 )); then
    PROFILE="cpu-16gb"
    OLLAMA_MODEL="auto"
    TOP_K="4"
    MAX_CONTEXT_CHARS="8000"
    GEN_NUM_CTX="2048"
    GEN_NUM_PREDICT="384"
    GEN_NUM_THREAD=""
  elif (( RAM_GB <= 32 )); then
    PROFILE="cpu-32gb"
    OLLAMA_MODEL="auto"
    TOP_K="5"
    MAX_CONTEXT_CHARS="12000"
    GEN_NUM_CTX="4096"
    GEN_NUM_PREDICT="640"
    GEN_NUM_THREAD=""
  else
    PROFILE="cpu-64gb"
    OLLAMA_MODEL="auto"
    TOP_K="6"
    MAX_CONTEXT_CHARS="16000"
    GEN_NUM_CTX="8192"
    GEN_NUM_PREDICT="1024"
    GEN_NUM_THREAD=""
  fi
}

write_env_file() {
  local cpu_model_env
  cpu_model_env="$(echo "$CPU_MODEL" | tr '[:space:]' '_' | tr -cd '[:alnum:]_().:-')"

  cat > .env <<EOF
# Auto-generated by build_docker.sh
DETECTED_CPU_MODEL=${cpu_model_env}
DETECTED_CPU_THREADS=${CPU_THREADS}
DETECTED_RAM_GB=${RAM_GB}
DETECTED_GPU_VENDOR=${GPU_VENDOR}
DETECTED_PROFILE=${PROFILE}

OLLAMA_MODEL=${OLLAMA_MODEL}
OLLAMA_AUTO_PULL=1
OFFLINE_STRICT=0
USE_CASE_NAME=Domain Assistant
CORPUS_PATH=/workspace/data/corpus

TOP_K=${TOP_K}
MAX_CONTEXT_CHARS=${MAX_CONTEXT_CHARS}
GEN_NUM_CTX=${GEN_NUM_CTX}
GEN_NUM_PREDICT=${GEN_NUM_PREDICT}
GEN_NUM_THREAD=${GEN_NUM_THREAD}
GEN_TEMPERATURE=0.2
EOF
  echo "Generated .env from detected host profile (${PROFILE})."
}

generate_compose_file() {
  if ! command -v docker >/dev/null 2>&1; then
    echo "Docker CLI not found. Install Docker and re-run."
    exit 1
  fi

  if [[ "$GPU_VENDOR" == "nvidia" ]]; then
    docker compose -f docker-compose.yml -f docker-compose.gpu.yml config > docker-compose-thislab.yml
  elif [[ "$GPU_VENDOR" == "amd" ]]; then
    docker compose -f docker-compose.yml -f docker-compose.gpu-amd.yml config > docker-compose-thislab.yml
  else
    docker compose -f docker-compose.yml config > docker-compose-thislab.yml
  fi

  echo "Generated docker-compose-thislab.yml"
}

build_images_only() {
  docker compose -f docker-compose-thislab.yml build
  echo "Docker images built successfully."
  echo "No containers were started."
}

echo "Detecting host hardware..."
detect_cpu_info
detect_ram_gb
GPU_VENDOR="$(detect_gpu_vendor)"

echo "CPU: ${CPU_MODEL} (${CPU_THREADS} threads)"
echo "RAM: ${RAM_GB} GB"
echo "GPU: ${GPU_VENDOR}"

install_gpu_drivers_if_missing
set_profile_values
write_env_file
generate_compose_file
build_images_only
